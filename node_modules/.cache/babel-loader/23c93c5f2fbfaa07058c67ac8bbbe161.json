{"ast":null,"code":"\"use strict\";\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  var desc = Object.getOwnPropertyDescriptor(m, k);\n  if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n    desc = {\n      enumerable: true,\n      get: function () {\n        return m[k];\n      }\n    };\n  }\n  Object.defineProperty(o, k2, desc);\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n  __setModuleDefault(result, mod);\n  return result;\n};\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.ProxyAgent = exports.proxies = void 0;\nconst http = __importStar(require(\"http\"));\nconst https = __importStar(require(\"https\"));\nconst url_1 = require(\"url\");\nconst lru_cache_1 = __importDefault(require(\"lru-cache\"));\nconst agent_base_1 = require(\"agent-base\");\nconst debug_1 = __importDefault(require(\"debug\"));\nconst proxy_from_env_1 = require(\"proxy-from-env\");\nconst pac_proxy_agent_1 = require(\"pac-proxy-agent\");\nconst http_proxy_agent_1 = require(\"http-proxy-agent\");\nconst https_proxy_agent_1 = require(\"https-proxy-agent\");\nconst socks_proxy_agent_1 = require(\"socks-proxy-agent\");\nconst debug = (0, debug_1.default)('proxy-agent');\nconst PROTOCOLS = [...http_proxy_agent_1.HttpProxyAgent.protocols, ...socks_proxy_agent_1.SocksProxyAgent.protocols, ...pac_proxy_agent_1.PacProxyAgent.protocols];\n/**\n * Supported proxy types.\n */\nexports.proxies = {\n  http: [http_proxy_agent_1.HttpProxyAgent, https_proxy_agent_1.HttpsProxyAgent],\n  https: [http_proxy_agent_1.HttpProxyAgent, https_proxy_agent_1.HttpsProxyAgent],\n  socks: [socks_proxy_agent_1.SocksProxyAgent, socks_proxy_agent_1.SocksProxyAgent],\n  socks4: [socks_proxy_agent_1.SocksProxyAgent, socks_proxy_agent_1.SocksProxyAgent],\n  socks4a: [socks_proxy_agent_1.SocksProxyAgent, socks_proxy_agent_1.SocksProxyAgent],\n  socks5: [socks_proxy_agent_1.SocksProxyAgent, socks_proxy_agent_1.SocksProxyAgent],\n  socks5h: [socks_proxy_agent_1.SocksProxyAgent, socks_proxy_agent_1.SocksProxyAgent],\n  'pac+data': [pac_proxy_agent_1.PacProxyAgent, pac_proxy_agent_1.PacProxyAgent],\n  'pac+file': [pac_proxy_agent_1.PacProxyAgent, pac_proxy_agent_1.PacProxyAgent],\n  'pac+ftp': [pac_proxy_agent_1.PacProxyAgent, pac_proxy_agent_1.PacProxyAgent],\n  'pac+http': [pac_proxy_agent_1.PacProxyAgent, pac_proxy_agent_1.PacProxyAgent],\n  'pac+https': [pac_proxy_agent_1.PacProxyAgent, pac_proxy_agent_1.PacProxyAgent]\n};\nfunction isValidProtocol(v) {\n  return PROTOCOLS.includes(v);\n}\n/**\n * Uses the appropriate `Agent` subclass based off of the \"proxy\"\n * environment variables that are currently set.\n *\n * An LRU cache is used, to prevent unnecessary creation of proxy\n * `http.Agent` instances.\n */\nclass ProxyAgent extends agent_base_1.Agent {\n  constructor(opts) {\n    super(opts);\n    /**\n     * Cache for `Agent` instances.\n     */\n    this.cache = new lru_cache_1.default({\n      max: 20\n    });\n    debug('Creating new ProxyAgent instance: %o', opts);\n    this.connectOpts = opts;\n    this.httpAgent = opts?.httpAgent || new http.Agent(opts);\n    this.httpsAgent = opts?.httpsAgent || new https.Agent(opts);\n    this.getProxyForUrl = opts?.getProxyForUrl || proxy_from_env_1.getProxyForUrl;\n  }\n  async connect(req, opts) {\n    const {\n      secureEndpoint\n    } = opts;\n    const isWebSocket = req.getHeader('upgrade') === 'websocket';\n    const protocol = secureEndpoint ? isWebSocket ? 'wss:' : 'https:' : isWebSocket ? 'ws:' : 'http:';\n    const host = req.getHeader('host');\n    const url = new url_1.URL(req.path, `${protocol}//${host}`).href;\n    const proxy = this.getProxyForUrl(url);\n    if (!proxy) {\n      debug('Proxy not enabled for URL: %o', url);\n      return secureEndpoint ? this.httpsAgent : this.httpAgent;\n    }\n    debug('Request URL: %o', url);\n    debug('Proxy URL: %o', proxy);\n    // attempt to get a cached `http.Agent` instance first\n    const cacheKey = `${protocol}+${proxy}`;\n    let agent = this.cache.get(cacheKey);\n    if (!agent) {\n      const proxyUrl = new url_1.URL(proxy);\n      const proxyProto = proxyUrl.protocol.replace(':', '');\n      if (!isValidProtocol(proxyProto)) {\n        throw new Error(`Unsupported protocol for proxy URL: ${proxy}`);\n      }\n      const ctor = exports.proxies[proxyProto][secureEndpoint || isWebSocket ? 1 : 0];\n      // @ts-expect-error mehâ€¦\n      agent = new ctor(proxy, this.connectOpts);\n      this.cache.set(cacheKey, agent);\n    } else {\n      debug('Cache hit for proxy URL: %o', proxy);\n    }\n    return agent;\n  }\n  destroy() {\n    for (const agent of this.cache.values()) {\n      agent.destroy();\n    }\n    super.destroy();\n  }\n}\nexports.ProxyAgent = ProxyAgent;","map":{"version":3,"mappings":"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","names":["debug","PROTOCOLS","http_proxy_agent_1","protocols","socks_proxy_agent_1","pac_proxy_agent_1","exports","http","https_proxy_agent_1","https","socks","socks4","socks4a","socks5","socks5h","isValidProtocol","v","includes","ProxyAgent","agent_base_1","constructor","opts","lru_cache_1","max","connectOpts","httpAgent","Agent","httpsAgent","getProxyForUrl","proxy_from_env_1","connect","req","secureEndpoint","isWebSocket","getHeader","protocol","host","url","url_1","path","href","proxy","cacheKey","agent","cache","get","proxyUrl","proxyProto","replace","Error","ctor","set","destroy","values"],"sources":["../src/index.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}