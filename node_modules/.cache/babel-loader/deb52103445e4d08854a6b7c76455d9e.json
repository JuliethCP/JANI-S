{"ast":null,"code":"\"use strict\";\n\nvar __createBinding = this && this.__createBinding || (Object.create ? function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  var desc = Object.getOwnPropertyDescriptor(m, k);\n  if (!desc || (\"get\" in desc ? !m.__esModule : desc.writable || desc.configurable)) {\n    desc = {\n      enumerable: true,\n      get: function () {\n        return m[k];\n      }\n    };\n  }\n  Object.defineProperty(o, k2, desc);\n} : function (o, m, k, k2) {\n  if (k2 === undefined) k2 = k;\n  o[k2] = m[k];\n});\nvar __setModuleDefault = this && this.__setModuleDefault || (Object.create ? function (o, v) {\n  Object.defineProperty(o, \"default\", {\n    enumerable: true,\n    value: v\n  });\n} : function (o, v) {\n  o[\"default\"] = v;\n});\nvar __importStar = this && this.__importStar || function (mod) {\n  if (mod && mod.__esModule) return mod;\n  var result = {};\n  if (mod != null) for (var k in mod) if (k !== \"default\" && Object.prototype.hasOwnProperty.call(mod, k)) __createBinding(result, mod, k);\n  __setModuleDefault(result, mod);\n  return result;\n};\nvar __importDefault = this && this.__importDefault || function (mod) {\n  return mod && mod.__esModule ? mod : {\n    \"default\": mod\n  };\n};\nObject.defineProperty(exports, \"__esModule\", {\n  value: true\n});\nexports.HttpProxyAgent = void 0;\nconst net = __importStar(require(\"net\"));\nconst tls = __importStar(require(\"tls\"));\nconst debug_1 = __importDefault(require(\"debug\"));\nconst events_1 = require(\"events\");\nconst agent_base_1 = require(\"agent-base\");\nconst debug = (0, debug_1.default)('http-proxy-agent');\n/**\n * The `HttpProxyAgent` implements an HTTP Agent subclass that connects\n * to the specified \"HTTP proxy server\" in order to proxy HTTP requests.\n */\nclass HttpProxyAgent extends agent_base_1.Agent {\n  constructor(proxy, opts) {\n    super(opts);\n    this.proxy = typeof proxy === 'string' ? new URL(proxy) : proxy;\n    this.proxyHeaders = opts?.headers ?? {};\n    debug('Creating new HttpProxyAgent instance: %o', this.proxy.href);\n    // Trim off the brackets from IPv6 addresses\n    const host = (this.proxy.hostname || this.proxy.host).replace(/^\\[|\\]$/g, '');\n    const port = this.proxy.port ? parseInt(this.proxy.port, 10) : this.proxy.protocol === 'https:' ? 443 : 80;\n    this.connectOpts = {\n      ...(opts ? omit(opts, 'headers') : null),\n      host,\n      port\n    };\n  }\n  addRequest(req, opts) {\n    req._header = null;\n    this.setRequestProps(req, opts);\n    // @ts-expect-error `addRequest()` isn't defined in `@types/node`\n    super.addRequest(req, opts);\n  }\n  setRequestProps(req, opts) {\n    const {\n      proxy\n    } = this;\n    const protocol = opts.secureEndpoint ? 'https:' : 'http:';\n    const hostname = req.getHeader('host') || 'localhost';\n    const base = `${protocol}//${hostname}`;\n    const url = new URL(req.path, base);\n    if (opts.port !== 80) {\n      url.port = String(opts.port);\n    }\n    // Change the `http.ClientRequest` instance's \"path\" field\n    // to the absolute path of the URL that will be requested.\n    req.path = String(url);\n    // Inject the `Proxy-Authorization` header if necessary.\n    const headers = typeof this.proxyHeaders === 'function' ? this.proxyHeaders() : {\n      ...this.proxyHeaders\n    };\n    if (proxy.username || proxy.password) {\n      const auth = `${decodeURIComponent(proxy.username)}:${decodeURIComponent(proxy.password)}`;\n      headers['Proxy-Authorization'] = `Basic ${Buffer.from(auth).toString('base64')}`;\n    }\n    if (!headers['Proxy-Connection']) {\n      headers['Proxy-Connection'] = this.keepAlive ? 'Keep-Alive' : 'close';\n    }\n    for (const name of Object.keys(headers)) {\n      const value = headers[name];\n      if (value) {\n        req.setHeader(name, value);\n      }\n    }\n  }\n  async connect(req, opts) {\n    req._header = null;\n    if (!req.path.includes('://')) {\n      this.setRequestProps(req, opts);\n    }\n    // At this point, the http ClientRequest's internal `_header` field\n    // might have already been set. If this is the case then we'll need\n    // to re-generate the string since we just changed the `req.path`.\n    let first;\n    let endOfHeaders;\n    debug('Regenerating stored HTTP header string for request');\n    req._implicitHeader();\n    if (req.outputData && req.outputData.length > 0) {\n      debug('Patching connection write() output buffer with updated header');\n      first = req.outputData[0].data;\n      endOfHeaders = first.indexOf('\\r\\n\\r\\n') + 4;\n      req.outputData[0].data = req._header + first.substring(endOfHeaders);\n      debug('Output buffer: %o', req.outputData[0].data);\n    }\n    // Create a socket connection to the proxy server.\n    let socket;\n    if (this.proxy.protocol === 'https:') {\n      debug('Creating `tls.Socket`: %o', this.connectOpts);\n      socket = tls.connect(this.connectOpts);\n    } else {\n      debug('Creating `net.Socket`: %o', this.connectOpts);\n      socket = net.connect(this.connectOpts);\n    }\n    // Wait for the socket's `connect` event, so that this `callback()`\n    // function throws instead of the `http` request machinery. This is\n    // important for i.e. `PacProxyAgent` which determines a failed proxy\n    // connection via the `callback()` function throwing.\n    await (0, events_1.once)(socket, 'connect');\n    return socket;\n  }\n}\nHttpProxyAgent.protocols = ['http', 'https'];\nexports.HttpProxyAgent = HttpProxyAgent;\nfunction omit(obj) {\n  const ret = {};\n  let key;\n  for (var _len = arguments.length, keys = new Array(_len > 1 ? _len - 1 : 0), _key = 1; _key < _len; _key++) {\n    keys[_key - 1] = arguments[_key];\n  }\n  for (key in obj) {\n    if (!keys.includes(key)) {\n      ret[key] = obj[key];\n    }\n  }\n  return ret;\n}","map":{"version":3,"mappings":"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","names":["debug","HttpProxyAgent","agent_base_1","constructor","proxy","opts","URL","proxyHeaders","headers","href","host","hostname","replace","port","parseInt","protocol","connectOpts","omit","addRequest","req","_header","setRequestProps","secureEndpoint","getHeader","base","url","path","String","username","password","auth","decodeURIComponent","Buffer","from","toString","keepAlive","name","Object","keys","value","setHeader","connect","includes","first","endOfHeaders","_implicitHeader","outputData","length","data","indexOf","substring","socket","tls","net","exports","obj","ret","key"],"sources":["../src/index.ts"],"sourcesContent":[null]},"metadata":{},"sourceType":"script"}